<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockly Robot Controller</title>

    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2>Controlează Robotul</h2>
    <div id="blocklyDiv" style="height: 500px; width: 100%;"></div>

    <xml id="toolbox" style="display: none">
        <block type="move_forward"></block>
        <block type="move_backward"></block>
        <block type="turn_left"></block>
        <block type="turn_right"></block>
    </xml>

    <script>
        let commandQueue = []; // 📌 Coada pentru execuție linie cu linie

        document.addEventListener("DOMContentLoaded", function() {
            console.log("🔄 Inițializare Blockly...");

            if (typeof Blockly === "undefined") {
                console.error("❌ Eroare: Blockly nu a fost încărcat corect!");
                return;
            }

            // 📌 Definește blocurile personalizate
            Blockly.Blocks['move_forward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi înainte");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_forward'] = function(block, generator) {
                return 'queueCommand("UP");\n';
            };

            Blockly.Blocks['move_backward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi înapoi");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_backward'] = function(block, generator) {
                return 'queueCommand("DOWN");\n';
            };

            Blockly.Blocks['turn_left'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire stânga");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_left'] = function(block, generator) {
                return 'queueCommand("LEFT");\n';
            };

            Blockly.Blocks['turn_right'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire dreapta");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_right'] = function(block, generator) {
                return 'queueCommand("RIGHT");\n';
            };

            // 📌 Inițializează Blockly după definirea blocurilor
            var workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

            console.log("✅ Blockly inițializat!");

            // 📌 Adaugă comenzile în coadă
            function queueCommand(command) {
                commandQueue.push(command);
            }

            // 📌 Funcție pentru trimiterea comenzilor către Flutter WebView
            function sendCommand(command) {
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler("BlocklyChannel", command);
                    console.log("📡 Trimite comanda către Flutter: " + command);
                } else {
                    console.warn("⚠️ WebView nu este disponibil, comanda '" + command + "' a fost salvată în coadă.");
                }
            }

            // 📌 Execută comenzile linie cu linie cu pauză între ele
            function executeCommands() {
                if (commandQueue.length === 0) {
                    console.log("✅ Toate comenzile au fost executate.");
                    return;
                }

                let command = commandQueue.shift();
                console.log("🚀 Execut comanda: " + command);
                sendCommand(command);

                setTimeout(executeCommands, 500); // Pauză de 500ms între comenzi
            }

            // 📌 Buton pentru rularea programului
            window.runProgram = function() {
                try {
                    commandQueue = []; // Golește coada înainte de rulare
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    console.log("📤 Cod generat:\n" + code);
                    eval(code); // Adaugă comenzile în coadă
                    executeCommands(); // Rulează comenzile treptat
                } catch (error) {
                    console.error("❌ Eroare la generarea/rularea codului:", error);
                }
            };

            // 📌 Funcție pentru preluarea comenzilor în Flutter
            window.getCommandLog = function() {
                return JSON.stringify(commandQueue);
            };
        });
    </script>

    <button onclick="runProgram()">Start Program</button>
</body>
</html>
