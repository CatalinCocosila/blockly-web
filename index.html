<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockly Robot Controller</title>

    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2>ControleazƒÉ Robotul</h2>
    <div id="blocklyDiv" style="height: 500px; width: 100%;"></div>

    <xml id="toolbox" style="display: none">
        <block type="move_forward"></block>
        <block type="move_backward"></block>
        <block type="turn_left"></block>
        <block type="turn_right"></block>
    </xml>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("üîÑ Ini»õializare Blockly...");

            if (typeof Blockly === "undefined") {
                console.error("‚ùå Eroare: Blockly nu a fost √ÆncƒÉrcat corect!");
                return;
            }

            // üìå Define custom blocks
            Blockly.Blocks['move_forward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi √Ænainte");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_forward'] = function(block, generator) {
                return 'sendCommand("UP");\n';
            };

            Blockly.Blocks['move_backward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi √Ænapoi");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_backward'] = function(block, generator) {
                return 'sendCommand("DOWN");\n';
            };

            Blockly.Blocks['turn_left'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire st√¢nga");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_left'] = function(block, generator) {
                return 'sendCommand("LEFT");\n';
            };

            Blockly.Blocks['turn_right'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire dreapta");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_right'] = function(block, generator) {
                return 'sendCommand("RIGHT");\n';
            };

            // üìå Initialize Blockly after defining blocks
            var workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

            console.log("‚úÖ Blockly ini»õializat!");

            // üìå Function to send commands to Flutter WebView
            function sendCommand(command) {
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler("BlocklyChannel", command);
                } else {
                    console.warn("‚ö†Ô∏è WebView nu este disponibil, comanda ignoratƒÉ:", command);
                }
            }

            // üìå Generate and run code when button is clicked
            window.runProgram = function() {
                try {
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    console.log("üì§ Cod generat:\n" + code);

                    // RuleazƒÉ comenzile doar dacƒÉ WebView este disponibil
                    if (window.flutter_inappwebview) {
                        eval(code);
                    } else {
                        console.warn("‚ö†Ô∏è WebView nu este disponibil, codul generat nu a fost executat.");
                    }
                } catch (error) {
                    console.error("‚ùå Eroare la generarea/rularea codului:", error);
                }
            };
        });
    </script>

    <button onclick="runProgram()">Start Program</button>
</body>
</html>
