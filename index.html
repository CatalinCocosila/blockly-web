<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockly Robot Controller</title>

    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2>ControleazÄƒ Robotul</h2>
    <div id="blocklyDiv" style="height: 500px; width: 100%;"></div>

    <xml id="toolbox" style="display: none">
        <block type="move_forward"></block>
        <block type="move_backward"></block>
        <block type="turn_left"></block>
        <block type="turn_right"></block>
    </xml>

    <script>
        let commandQueue = []; // ğŸ“Œ Coada pentru execuÈ›ie linie cu linie

        document.addEventListener("DOMContentLoaded", function() {
            console.log("ğŸ”„ IniÈ›ializare Blockly...");

            if (typeof Blockly === "undefined") {
                console.error("âŒ Eroare: Blockly nu a fost Ã®ncÄƒrcat corect!");
                return;
            }

            // ğŸ“Œ DefineÈ™te blocurile personalizate
            Blockly.Blocks['move_forward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi Ã®nainte");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_forward'] = function(block, generator) {
                return 'queueCommand("UP");\n';
            };

            Blockly.Blocks['move_backward'] = {
                init: function() {
                    this.appendDummyInput().appendField("Mergi Ã®napoi");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['move_backward'] = function(block, generator) {
                return 'queueCommand("DOWN");\n';
            };

            Blockly.Blocks['turn_left'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire stÃ¢nga");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_left'] = function(block, generator) {
                return 'queueCommand("LEFT");\n';
            };

            Blockly.Blocks['turn_right'] = {
                init: function() {
                    this.appendDummyInput().appendField("Rotire dreapta");
                    this.setPreviousStatement(true);
                    this.setNextStatement(true);
                    this.setColour(230);
                }
            };
            Blockly.JavaScript.forBlock['turn_right'] = function(block, generator) {
                return 'queueCommand("RIGHT");\n';
            };

            // ğŸ“Œ IniÈ›ializeazÄƒ Blockly dupÄƒ definirea blocurilor
            var workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

            console.log("âœ… Blockly iniÈ›ializat!");

            // ğŸ“Œ AdaugÄƒ comenzile Ã®n coadÄƒ
            function queueCommand(command) {
                commandQueue.push(command);
            }

            // ğŸ“Œ FuncÈ›ie pentru trimiterea comenzilor cÄƒtre Flutter WebView
            function sendCommand(command) {
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler("BlocklyChannel", command);
                    console.log("ğŸ“¡ Trimite comanda cÄƒtre Flutter: " + command);
                } else {
                    console.warn("âš ï¸ WebView nu este disponibil, comanda '" + command + "' a fost salvatÄƒ Ã®n coadÄƒ.");
                }
            }

            // ğŸ“Œ ExecutÄƒ comenzile linie cu linie cu pauzÄƒ Ã®ntre ele
            function executeCommands() {
                if (commandQueue.length === 0) {
                    console.log("âœ… Toate comenzile au fost executate.");
                    return;
                }

                let command = commandQueue.shift();
                console.log("ğŸš€ Execut comanda: " + command);
                sendCommand(command);

                setTimeout(executeCommands, 500); // PauzÄƒ de 500ms Ã®ntre comenzi
            }

            // ğŸ“Œ Buton pentru rularea programului
            window.runProgram = function() {
                try {
                    commandQueue = []; // GoleÈ™te coada Ã®nainte de rulare
                    var code = Blockly.JavaScript.workspaceToCode(workspace);
                    console.log("ğŸ“¤ Cod generat:\n" + code);
                    eval(code); // AdaugÄƒ comenzile Ã®n coadÄƒ
                    executeCommands(); // RuleazÄƒ comenzile treptat
                } catch (error) {
                    console.error("âŒ Eroare la generarea/rularea codului:", error);
                }
            };

            // ğŸ“Œ FuncÈ›ie pentru preluarea comenzilor Ã®n Flutter
            window.getCommandLog = function() {
                return JSON.stringify(commandQueue);
            };
        });
    </script>

    <button onclick="runProgram()">Start Program</button>
</body>
</html>
